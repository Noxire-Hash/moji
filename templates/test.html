{% extends "base.html" %}

{% block title %}Moji - Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/style/app.css">
{% endblock %}

{% block content %}
<div class="app-container">
  <!-- Header -->
  <header class="app-header">
    <div class="header-left">
      <a href="{{ url_for('index') }}" class="logo">Moji</a>
      <div class="project-selector">
        <select id="project-select" class="form-select">
          <option value="personal">Personal</option>
          <option value="work">Work</option>
          <option value="ideas">Ideas</option>
        </select>
      </div>
      <button class="btn btn-sm new-btn" id="new-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
        </svg>
        New
      </button>
    </div>
    <div class="header-right">
      <button class="btn btn-icon" id="search-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
        </svg>
      </button>
      <button class="btn btn-icon" id="profile-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
        </svg>
      </button>
      <button class="btn btn-icon" id="menu-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="app-main">
    <!-- Left Section - Todos -->
    <section class="todos-section">
      <div class="section-header">
        <h2>TODOS</h2>
        <button class="btn btn-icon collapse-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8z"/>
          </svg>
        </button>
      </div>
      <div class="todos-list">
        <div class="todo-item">
          <div class="custom-checkbox-wrapper">
            <input type="checkbox" id="todo1">
            <label for="todo1">
              <span class="task-text">Fix authentication bug</span>
            </label>
          </div>
        </div>
        <div class="todo-item">
          <div class="custom-checkbox-wrapper">
            <input type="checkbox" id="todo2">
            <label for="todo2">
              <span class="task-text">Update CSS for dark mode</span>
            </label>
          </div>
        </div>
        <div class="todo-item">
          <div class="custom-checkbox-wrapper">
            <input type="checkbox" id="todo3" checked>
            <label for="todo3">
              <span class="task-text">Set up project structure</span>
            </label>
          </div>
        </div>
        <div class="todo-item">
          <div class="custom-checkbox-wrapper">
            <input type="checkbox" id="todo4">
            <label for="todo4">
              <span class="task-text">Write documentation</span>
            </label>
          </div>
        </div>
        <div class="todo-item">
          <div class="custom-checkbox-wrapper">
            <input type="checkbox" id="todo5">
            <label for="todo5">
              <span class="task-text">Implement user authentication</span>
            </label>
          </div>
        </div>
      </div>
    </section>

    <!-- Right Section - Notes -->
    <section class="notes-section">
      <div class="section-header">
        <h2>NOTES</h2>
      </div>
      <div class="notes-list">
        <div class="note-card" data-id="1">
          <h3>Meeting Notes</h3>
          <div class="note-preview">Team meeting about new features...</div>
        </div>
        <div class="note-card" data-id="2">
          <h3>Auth Research</h3>
          <div class="note-preview">JWT vs session-based authentication...</div>
        </div>
        <div class="note-card" data-id="3">
          <h3>API Design</h3>
          <div class="note-preview">REST endpoints for the user system...</div>
        </div>
      </div>
    </section>

    <!-- Projects Panel (hidden by default on mobile) -->
    <section class="projects-panel">
      <div class="section-header">
        <h2>PROJECTS</h2>
      </div>
      <div class="projects-list">
        <div class="project-item active">
          <span class="project-name">Personal</span>
        </div>
        <div class="project-item">
          <span class="project-name">Work</span>
        </div>
        <div class="project-item">
          <span class="project-name">Ideas</span>
        </div>
        <div class="project-item add-project">
          <span class="project-name">+ Add Project</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Updated Command Bar - Floating style with upward expansion -->
  <div class="command-bar">
    <div class="command-suggestions">
      <!-- Dynamic content goes here -->
    </div>
    <div class="input-wrapper">
      <textarea id="command-input" placeholder="What's on your mind? [/help for commands]" rows="1"></textarea>
    </div>
  </div>

  <!-- Modal for Note Editing -->
  <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="noteModalLabel">Edit Note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control mb-3" id="note-title" placeholder="Note Title">
          <textarea class="form-control" id="note-content" rows="10" placeholder="Note content..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn cta-button" id="save-note">Save Note</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Modal for Project Creation -->
  <div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalLabel">Create Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control mb-3" id="project-name" placeholder="Project Name">
          <textarea class="form-control" id="project-description" rows="10" placeholder="Project description..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn cta-button" id="add-project">Add Project</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Auto-resize textarea as you type
  const commandInput = document.getElementById('command-input');
  const commandSuggestions = document.querySelector('.command-suggestions');

  // Function to adjust input height
  function adjustInputHeight() {
    // Reset height to auto first to shrink if needed
    commandInput.style.height = 'auto';

    // Calculate the right height (between min and max height)
    const newHeight = Math.min(Math.max(commandInput.scrollHeight, 48), 150);
    commandInput.style.height = newHeight + 'px';
  }

  // Adjust height on input
  commandInput.addEventListener('input', adjustInputHeight);

  // Initialize height on page load
  window.addEventListener('load', adjustInputHeight);

  // Sample commands
  const commands = [
    { command: '/todo', description: 'Create a new todo' },
    { command: '/note', description: 'Create a new note' },
    { command: '/project', description: 'Create/switch project' },
    { command: '/help', description: 'Show all commands' }
  ];

  // Show appropriate suggestions based on input
  commandInput.addEventListener('input', function() {
    const input = this.value.toLowerCase();

    if (input.startsWith('/')) {
      const matchingCommands = commands.filter(cmd =>
        cmd.command.startsWith(input)
      );

      if (matchingCommands.length > 0) {
        commandSuggestions.innerHTML = matchingCommands.map(cmd =>
          `<div class="command-suggestion">${cmd.command} - ${cmd.description}</div>`
        ).join('');
        commandSuggestions.style.display = 'block';
      } else {
        commandSuggestions.style.display = 'none';
      }
    } else {
      commandSuggestions.style.display = 'none';
    }
  });

  // Process command on Enter (without shift)
  commandInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault(); // Prevent default newline
      processCommand();
    }
  });

  commandInput.addEventListener('keydown', function(e) {
    if (e.keyCode === 9) {
      e.preventDefault();
      commandSuggestions.innerHTML = '';
      console.log('Tab pressed');
      commandInput.value = '';
    }
  });

  // Function to process the command
  function processCommand() {
    const input = commandInput.value.trim();

    if (!input) return;

    if (input.startsWith('/todo ')) {
      // Add todo logic
      const todoText = input.slice(6);
      addTodo(todoText);
      commandInput.value = '';
    } else if (input.startsWith('/note ')) {
      // Add note logic
      const noteText = input.slice(6);
      addNote(noteText);
      commandInput.value = '';
    } else if (input === '/help') {
      // Show help
      showHelp();
      commandInput.value = '';
    } else {
      // For regular text (not commands), create as a note by default
      addNote(input);
      commandInput.value = '';
    }

    // Reset height and hide suggestions
    adjustInputHeight();
    commandSuggestions.style.display = 'none';
  }

  // Sample function to add todo
  function addTodo(text) {
    const todosList = document.querySelector('.todos-list');
    const todoId = 'todo' + (todosList.children.length + 1);

    const todoItem = document.createElement('div');
    todoItem.className = 'todo-item';
    todoItem.innerHTML = `
      <div class="custom-checkbox-wrapper">
        <input type="checkbox" id="${todoId}">
        <label for="${todoId}">
          <span class="task-text">${text}</span>
        </label>
      </div>
    `;

    todosList.appendChild(todoItem);
  }

  // Sample function to add note
  function addNote(text) {
    const notesList = document.querySelector('.notes-list');
    const noteId = notesList.children.length + 1;

    const noteCard = document.createElement('div');
    noteCard.className = 'note-card';
    noteCard.setAttribute('data-id', noteId);
    noteCard.innerHTML = `
      <h3>New Note</h3>
      <div class="note-preview">${text.slice(0, 50)}${text.length > 50 ? '...' : ''}</div>
    `;

    notesList.appendChild(noteCard);
  }

  // Sample function to show help
  function showHelp() {
    commandSuggestions.innerHTML = `
      <div class="command-help">
        <h3>COMMAND HELP:</h3>
        <div class="command-list">
          ${commands.map(cmd => `<div class="command-item">${cmd.command} - ${cmd.description}</div>`).join('')}
        </div>
      </div>
    `;
    commandSuggestions.style.display = 'block';
  }

  // Initialize click handlers for suggestion commands
  document.addEventListener('DOMContentLoaded', function() {
    commandSuggestions.addEventListener('click', function(e) {
      if (e.target.classList.contains('command-suggestion')) {
        const commandText = e.target.textContent.split(' - ')[0];
      commandInput.value = commandText + ' ';
      commandInput.focus();
        commandSuggestions.style.display = 'none';
      }
    });
  });

  // Note modal handling
  const noteCards = document.querySelectorAll('.note-card');
  let noteModal;
  let projectModal;
  // Initialize modal after DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    console.log('Note cards found:', noteCards.length);

    try {
      noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
      projectModal = new bootstrap.Modal(document.getElementById('projectModal'));
      console.log('Modal initialized successfully');
    } catch (error) {
      console.error('Error initializing modal:', error);
    }

    noteCards.forEach(card => {
      card.addEventListener('click', function() {
        console.log('Note card clicked');
        const noteId = this.getAttribute('data-id');
        const noteTitle = this.querySelector('h3').textContent;
        console.log('Note ID:', noteId, 'Title:', noteTitle);

        document.getElementById('noteModalLabel').textContent = noteTitle;
        document.getElementById('note-title').value = noteTitle;

        // In a real app, you'd fetch the full note content
        document.getElementById('note-content').value = 'This is the full content of note #' + noteId;

        try {
          noteModal.show();
          console.log('Modal show called');
        } catch (error) {
          console.error('Error showing modal:', error);
        }
      });
    });
    projectCards.forEach(card => {
      card.addEventListener('click', function() {
        const projectName = this.querySelector('.project-name').textContent;
        const projectDescription = this.querySelector('.project-description').textContent;
        const projectAdd = this.querySelector('.add-project').textContent;
        async function addProject() {

        projectModal.show();
        }
      });
    });
  });

  // Add event listeners for new buttons
  document.getElementById('new-btn').addEventListener('click', function() {
    // Show a dropdown or a modal with options to create a new todo, note, or project
    alert('Create new item: Todo, Note, or Project');
  });

  document.getElementById('search-btn').addEventListener('click', function() {
    // Show search interface
    alert('Search functionality coming soon!');
  });

  document.getElementById('profile-btn').addEventListener('click', function() {
    // Show profile or settings
    alert('User profile and settings coming soon!');
  });

  document.getElementById('menu-btn').addEventListener('click', function() {
    // Show main menu or navigation
    alert('Main menu coming soon!');
  });

  // Project selection
  document.getElementById('project-select').addEventListener('change', function() {
    const projectName = this.value;

    // Update active project in sidebar
    const projectItems = document.querySelectorAll('.project-item');
    projectItems.forEach(item => {
      const name = item.querySelector('.project-name').textContent.toLowerCase();
      if (name === projectName) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });

    // In a real app, you'd load the todos and notes for the selected project
    alert(`Switched to ${projectName} project`);
  });

  // Project sidebar item click
  const projectItems = document.querySelectorAll('.project-item');

  projectItems.forEach(item => {
    const projectModalSaveBtn = document.getElementById('add-project');
    if (!item.classList.contains('add-project')) {
      item.addEventListener('click', function() {
        const projectName = this.querySelector('.project-name').textContent;

        // Update dropdown
        document.getElementById('project-select').value = projectName.toLowerCase();

        // Update active state
        projectItems.forEach(p => p.classList.remove('active'));
        this.classList.add('active');

        // In a real app, you'd load the todos and notes for the selected project
        alert(`Switched to ${projectName} project`);
      });
    } else {
      item.addEventListener('click', function() {
        // Show dialog to add a new project
        projectModal.show();
        projectModalSaveBtn.addEventListener('click', function() {
          const projectName = document.getElementById('project-name').value;
          const projectDescription = document.getElementById('project-description').value;
          const projectAdd = document.getElementById('add-project').textContent;
          alert(`Project added: ${projectName}`);

          async function addProject() {
            const project = {
              name: projectName,
              description: projectDescription
            };
            fetch('/api/v1/create-project', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(project)
            });
            console.log(project);
          }
        });
      });
    }
  });

  // Make sure to focus the command input when the page loads
  window.addEventListener('load', function() {
    commandInput.focus();
  });
</script>
{% endblock %}

{% block extra_scripts %}
{% endblock %}
